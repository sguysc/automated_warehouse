function final_point_control_check()
close all
times=0:0.01:10;
xf = [ 1.50000000e+00; 0;  7.85398163e-01];
% x0 = xf+[.5*2*(rand(2,1)-.5); .05*2*(rand(1,1)-.5)];
x0 = [1.04; .332 ; 0.797];
figure;
subplot(211);
options = odeset('RelTol',1e-5,'Stats','on','OutputFcn',@odeplot);
[T, xcl] = ode45(@(t,x)approx_dynamics(t, x, xf), ...
                    times, x0, options) ;
% figure;
% plot(xcl(:,1), xcl(:,2)); hold all
%plot(x(1,:), x(2,:));
hold all;
V = (((-1.4999999999999998 + xcl(:,1)) .* (4.8008600999593014 .* (-1.4999999999999998 + xcl(:,1)) ...
       - 0.98790740152737377 .* (-0.78539816339744839 + xcl(:,3)) - 1.4491942689985993 .* ...
       (6.9388939039072284e-18 + xcl(:,2)))) + ((-0.78539816339744839 + xcl(:,3)) .* ( - ...
       0.98790740152737322 .* (-1.4999999999999998 + xcl(:,1)) + 1.4361830490185388 .* ...
       (-0.78539816339744839 + xcl(:,3)) + 0.68372066922887398 .* (6.9388939039072284e-18 + ...
       xcl(:,2)))) + (( - 1.4491942689985997 .* (-1.4999999999999998 + xcl(:,1)) + ...
       0.68372066922887442 .* (-0.78539816339744839 + xcl(:,3)) + 4.5682688351564416 ...
       * (6.9388939039072284e-18 + xcl(:,2))) .* (6.9388939039072284e-18 + xcl(:,2))));
Vdot = diff(V)./diff(T);
plot(T, 100*V);
plot(T(2:end), 10*Vdot);
Qf =  [ 4.8008601 , -1.44919427, -0.9879074 ;
       -1.44919427,  4.56826884,  0.68372067;
       -0.9879074 ,  0.68372067,  1.43618305];
tmp = Qf*(xcl-xf')';
Vanother = zeros(size(T));
for i=1:size(tmp,2)
    Vanother(i) = (xcl(i,:)-xf')*tmp(:,i);
end
plot(T, 100*Vanother, '.');  
   
subplot(212);
[T, xcl] = ode45(@(t,x)full_dynamics(t, x, xf), ...
                    times, x0, options) ;
hold all;
V = (((-1.4999999999999998 + xcl(:,1)) .* (4.8008600999593014 .* (-1.4999999999999998 + xcl(:,1)) ...
       - 0.98790740152737377 .* (-0.78539816339744839 + xcl(:,3)) - 1.4491942689985993 .* ...
       (6.9388939039072284e-18 + xcl(:,2)))) + ((-0.78539816339744839 + xcl(:,3)) .* ( - ...
       0.98790740152737322 .* (-1.4999999999999998 + xcl(:,1)) + 1.4361830490185388 .* ...
       (-0.78539816339744839 + xcl(:,3)) + 0.68372066922887398 .* (6.9388939039072284e-18 + ...
       xcl(:,2)))) + (( - 1.4491942689985997 .* (-1.4999999999999998 + xcl(:,1)) + ...
       0.68372066922887442 .* (-0.78539816339744839 + xcl(:,3)) + 4.5682688351564416 ...
       * (6.9388939039072284e-18 + xcl(:,2))) .* (6.9388939039072284e-18 + xcl(:,2))));
Vdot = diff(V)./diff(T);
plot(T, 100*V);
plot(T(2:end), 10*Vdot);

end


function xdot = the_dynamics(t, x)
    xdot = x;

    xdot(1) = (( - 1.7996170331373038 * (-1.4999999999999998 + x(1)) - 0.614088168801185 * (-0.78539816339744839 + x(3)) - 2.6002650891865011 * (6.9388939039072284e-18 + x(2))) * (0.70710678118654746 - 0.70710678118654757 * (-0.78539816339744839 + x(3)) - ((0.70710678118654746 * ((-0.78539816339744839 + x(3))^2)) / 2) + ((0.70710678118654746 * ((-0.78539816339744839 + x(3))^4)) / 24) + ((0.70710678118654757 * ((-0.78539816339744839 + x(3))^3)) / 6)));
    xdot(2) = (( - 1.7996170331373038 * (-1.4999999999999998 + x(1)) - 0.614088168801185 * (-0.78539816339744839 + x(3)) - 2.6002650891865011 * (6.9388939039072284e-18 + x(2))) * (0.70710678118654757 + 0.70710678118654746 * (-0.78539816339744839 + x(3)) - ((0.70710678118654746 * ((-0.78539816339744839 + x(3))^3)) / 6) - ((0.70710678118654757 * ((-0.78539816339744839 + x(3))^2)) / 2)));
    xdot(3) = (( - 1.7996170331373038 * (-1.4999999999999998 + x(1)) - 0.614088168801185 * (-0.78539816339744839 + x(3)) - 2.6002650891865011 * (6.9388939039072284e-18 + x(2))) * (2.600265089186502 * (-1.4999999999999998 + x(1)) - 3.7801687063692455 * (-0.78539816339744839 + x(3)) - 1.7996170331373023 * (6.9388939039072284e-18 + x(2)) + ((2 * ((2.600265089186502 * (-1.4999999999999998 + x(1)) - 3.7801687063692455 * (-0.78539816339744839 + x(3)) - 1.7996170331373023 * (6.9388939039072284e-18 + x(2)))^3)) / 6)));
    
end


function xdot = approx_dynamics(t,x,x_d)
    xdot = x;
    L=1;
    u_d = [0;0];
    K = [-2.60026509,  1.79961703,  3.78016871; ...
          1.79961703,  2.60026509,  0.61408817];

    
    U = u_d - K*(x-x_d); 
	delta_fb = U(1);
	u_fb = U(2);
	theta = x(3);
            
%   xdot(1) = u_fb*taylor_cos(theta, x_d(3));
% 	xdot(2) = u_fb*taylor_sin(theta, x_d(3));
% 	xdot(3) = u_fb*taylor_tan(delta_fb, u_d(1))/L;
    xdot(1) = (1.3958786076030871 - 1.2725214054517944 * (-1.4999999999999998 + x(1)) - 1.8301045168565246 * (-0.78539816339744839 + x(3)) - 1.8386650780216482 * (6.9388939039072284e-18 + x(2)) + ((-0.52742678909621221 * ((-0.78539816339744839 + x(3))^2)) / 2) + ((1.2725214054517944 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^2)) / 6) + ((1.2725214054517946 * (-1.4999999999999998 + x(1)) * (-0.78539816339744839 + x(3))) / 2) + ((1.8386650780216482 * ((-0.78539816339744839 + x(3))^2) * (6.9388939039072284e-18 + x(1))) / 6) + ((1.8386650780216485 * (-0.78539816339744839 + x(2)) * (6.9388939039072284e-18 + x(1))) / 2) + ((2.6985563353633992 * pow((-0.78539816339744839 + x(2)), 3)) / 6));
    xdot(2) = (1.3958786076030874 - 1.2725214054517946 * (-1.4999999999999998 + x(1)) + 0.96165269834964962 * (-0.78539816339744839 + x(3)) - 1.8386650780216485 * (6.9388939039072284e-18 + x(2)) + ((-2.2643304261099622 * ((-0.78539816339744839 + x(3))^2)) / 2) + ((-1.8386650780216482 * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 2) + ((-1.2725214054517944 * (-1.4999999999999998 + x(1)) * (-0.78539816339744839 + x(3))) / 2) + ((-0.093200879842774809 * ((-0.78539816339744839 + x(3))^3)) / 6) + ((1.2725214054517946 * (-1.4999999999999998 + x(0)) * pow((-0.78539816339744839 + x(2)), 2)) / 6) + ((1.8386650780216485 * pow((-0.78539816339744839 + x(2)), 2) * (6.9388939039072284e-18 + x(1))) / 6));
    xdot(3) = (1.1397301104980757 + 5.8051326205106797 * (-1.4999999999999998 + x(1)) - 10.304303140650759 * (-0.78539816339744839 + x(3)) - 6.2380248365750184 * (6.9388939039072284e-18 + x(2)) + ((-609.24586465530081 * ((-0.78539816339744839 + x(3))^3)) / 6) + ((-340.81750143269858 * ((-0.78539816339744839 + x(3))^2) * (6.9388939039072284e-18 + x(2))) / 6) + ((-221.02020264115635 * ((-1.4999999999999998 + x(1))^2) * (-0.78539816339744839 + x(3))) / 6) + ((-186.42466976042397 * (-0.78539816339744839 + x(3)) * pow((6.9388939039072284e-18 + x(1)), 2)) / 6) + ((-129.24563906812699 * pow((-1.4999999999999998 + x(0)), 2) * (6.9388939039072284e-18 + x(1))) / 6) + ((-100.25850423713614 * pow((6.9388939039072284e-18 + x(1)), 3)) / 6) + ((-22.933006912830564 * (-1.4999999999999998 + x(0)) * (-0.78539816339744839 + x(2))) / 2) + ((-18.919264866082951 * (-1.4999999999999998 + x(0)) * (6.9388939039072284e-18 + x(1))) / 2) + ((8.0711076535103636 * pow((-1.4999999999999998 + x(0)), 2)) / 2) + ((22.321695271643801 * pow((6.9388939039072284e-18 + x(1)), 2)) / 2) + ((35.255205160837612 * (-0.78539816339744839 + x(2)) * (6.9388939039072284e-18 + x(1))) / 2) + ((49.620614119280404 * pow((-0.78539816339744839 + x(2)), 2)) / 2) + ((117.15650935717419 * (-1.4999999999999998 + x(0)) * pow((6.9388939039072284e-18 + x(1)), 2)) / 6) + ((128.90225364562065 * pow((-1.4999999999999998 + x(0)), 3)) / 6) + ((211.16533952815934 * (-1.4999999999999998 + x(0)) * (-0.78539816339744839 + x(2)) * (6.9388939039072284e-18 + x(1))) / 6) + ((370.19648840814267 * (-1.4999999999999998 + x(0)) * pow((-0.78539816339744839 + x(2)), 2)) / 6));
end


function xdot = full_dynamics(t,x,x_d)
    xdot = x;
    L=1;
    u_d = [0;0];
    K = [-2.60026509,  1.79961703,  3.78016871; ...
          1.79961703,  2.60026509,  0.61408817];

    
    U = u_d - K*(x-x_d); 
	delta_fb = U(1);
	u_fb = U(2);
	theta = x(3);
            
    xdot(1) = u_fb*cos(theta);
	xdot(2) = u_fb*sin(theta);
	xdot(3) = u_fb*tan(delta_fb)/L;
end

function tc = taylor_cos(x, x0)
	tc = ( cos(x0) - sin(x0)*(x-x0) - (cos(x0)*(x-x0)^2)/2.0 ...
		 + (sin(x0)*(x-x0)^3)/6.0 + (cos(x0)*(x-x0)^4)/24.0 ) ;
end

function ts = taylor_sin(x, x0)
    ts = ( sin(x0) + cos(x0)*(x-x0) - (sin(x0)*(x-x0)^2)/2.0 ...
         - (cos(x0)*(x-x0)^3)/6.0  ) ;
end
function tt = taylor_tan(x, x0)
	tt = ( tan(x0) + (tan(x0)^2+1.0)*(x-x0) + ...
	     ((2.0*tan(x0)*(tan(x0)^2 + 1.0))*(x-x0)^2)/2.0  + ...
	     ((2.0*(tan(x0)^2 + 1)^2 + (4.0*tan(x0)^2)*(tan(x0)^2 + 1.0))...
             *(x-x0)^3)/6.0 );
end