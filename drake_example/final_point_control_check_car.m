function final_point_control_check()
close all
times=0:0.01:10;

% xf =[1.38669205, 0.61862571, 0.6697654 ]'; 
xf = [1.86756251, 1.10343839, 0.81388533]';
T = eye(3); 
% T = [-0.08434561,  0.00531625;
%       0.25015733,  0.20463393];
xf = T*xf;
uf = [-0.0689047 ,  1.15555556]';% [-1.3962634 ,  1.15555556]';
R = 0.01;
x0 = xf+R*[2*(rand(size(xf))-.5);];
figure;
% A = [0, 1; -10*cos(xf(1)) -1]; B = [0;1];
% [K,~,~]= lqr(A,B,10*eye(2),1*eye(1));
K = [-1.29069666,  1.62922409,  3.05429366; ...
      1.62508858,  1.88103145,  0.07518857];
options = odeset('RelTol',1e-5);%,'Stats','on','OutputFcn',@odeplot);
[T, x] = ode45(@(t,x)car_dynamics(t, x, K, uf, xf), ...
                    times, x0, options) ;

% plot(T, xf(1)-x(:,1),'b-', T, xf(2)-x(:,2), 'g-', T, xf(3)-x(:,3), 'r-'); hold all;
plot(T, x(:,1),'b-', T, x(:,2), 'g-', T, x(:,3), 'r-'); hold all;
plot([T(1) T(end)], [xf(1) xf(1)], 'b');
plot([T(1) T(end)], [xf(2) xf(2)], 'g');
plot([T(1) T(end)], [xf(3) xf(3)], 'r');

[T, x] = ode45(@(t,x)car_approx_dynamics(t, x, xf), ...
                    times, x0, options) ;

plot(T, x(:,1),'b:', T, x(:,2), 'g:', T, x(:,3), 'r:'); hold all;
% V = (((-3.1000000000000001 + x(:,1)) .* (1.4837669049548923 .* (-3.1000000000000001 + x(:,1)) - 0.54459785166515851 .* (-1.8999999999999999 + x(:,2)) + 0.0016067430675332931 .* (-0.10000000000000003 + x(:,3)))) + ((-1.8999999999999999 + x(:,2)) .* ( - 0.54459785166515862 .* (-3.1000000000000001 + x(:,1)) + 6.9054387378206794 .* (-1.8999999999999999 + x(:,2)) + 0.036868266945400185 .* (-0.10000000000000003 + x(:,3)))) + ((-0.10000000000000003 + x(:,3)) .* (0.0016067430675332939 .* (-3.1000000000000001 + x(:,1)) + 0.036868266945400185 .* (-1.8999999999999999 + x(:,2)) + 0.036527396478655862 .* (-0.10000000000000003 + x(:,3)))));
% plot(T, V);
zoom on
return
figure;
[x, y] = meshgrid(-2:0.1:2, -2:0.1:2);
z = xf(3)*zeros(size(x));
% V = ((x .* (1.2710439216280629 .* x + 0.041416275308525152 .* y - 0.0062330193291722513 .* z)) + (y .* (0.041416275308525152 .* x + 0.93737513363479996 .* y + 0.13005899823762895 .* z)) + (z .* ( - 0.0062330193291722027 .* x + 0.13005899823762895 .* y + 0.14413063778897017 .* z)));
% Vdot = ((( - 4.123991426359594 .* x - 23.646710430174462 .* y - 27.530004103469132 .* z + ((-842.38518808143465 .* (z.^3)) ./ 6) + 2 .* ((-724.55952735254027 .* y .* (z.^2)) ./ 6) + ((-724.55952735254016 .* y .* (z.^2)) ./ 6) + ((-623.20982967158932 .* (y.^2) .* z) ./ 6) + 2 .* ((-623.20982967158909 .* (y.^2) .* z) ./ 6) + ((-536.03281201954962 .* (y.^3)) ./ 6) + 2 .* ((-141.25061610207391 .* x .* (z.^2)) ./ 6) + ((-141.25061610207388 .* x .* (z.^2)) ./ 6) + 2 .* ((-121.42601259684383 .* x .* y .* z) ./ 6) + ((-121.42601259684379 .* x .* y .* z) ./ 6) + 3 .* ((-121.42601259684378 .* x .* y .* z) ./ 6) + 3 .* ((-104.38270636332155 .* x .* (y.^2)) ./ 6) + ((-91.078972005052165 .* (z.^2)) ./ 2) + 2 .* ((-77.930402411031281 .* y .* z) ./ 2) + ((-66.675806993664608 .* (y.^2)) ./ 2) + 2 .* ((-22.664038859713386 .* (x.^2) .* z) ./ 6) + ((-22.664038859713383 .* (x.^2) .* z) ./ 6) + 2 .* ((-19.466580820491501 .* (x.^2) .* y) ./ 6) + ((-19.466580820491497 .* (x.^2) .* y) ./ 6) + 2 .* ((-9.0992598875724564 .* x .* z) ./ 2) + ((-7.7221084999052971 .* x .* y) ./ 2) + ((-7.7221084999052962 .* x .* y) ./ 2) + ((-3.3868985363560489 .* (x.^3)) ./ 6) + ((0.049416654099535551 .* (x.^2)) ./ 2)) .* ( - 0.012466038658344454 .* x + 0.26011799647525791 .* y + 0.28826127557794035 .* z)) + (( - 2.3727308015319104 .* x + 0.55708911045314402 .* y + 0.10270492023415845 .* z + ((-7.531485227842035 .* (z.^2)) ./ 2) + ((-1.7855700002399373 .* (z.^3)) ./ 6) + 3 .* ((-0.55708911045314402 .* y .* (z.^2)) ./ 6) + 2 .* ((-0.055895353219691496 .* y .* z) ./ 2) + 2 .* ((0.23806716691875224 .* x .* z) ./ 2) + 3 .* ((2.3727308015319104 .* x .* (z.^2)) ./ 6)) .* (2.5420878432561258 .* x + 0.082832550617050305 .* y - 0.012466038658344454 .* z)) + (( - 0.23806716691875224 .* x + 0.055895353219691496 .* y + 7.4470603698588169 .* z + ((-7.6159100858252522 .* (z.^3)) ./ 6) + 2 .* ((-2.3727308015319104 .* x .* z) ./ 2) + 3 .* ((-0.055895353219691496 .* y .* (z.^2)) ./ 6) + 3 .* ((0.23806716691875224 .* x .* (z.^2)) ./ 6) + 2 .* ((0.55708911045314402 .* y .* z) ./ 2) + ((0.94413746023704781 .* (z.^2)) ./ 2)) .* (0.082832550617050305 .* x + 1.8747502672695999 .* y + 0.26011799647525791 .* z)));

% surf(x,y,V, 'FaceAlpha',0.2); hold all;
% surf(x,y,Vdot, 'FaceAlpha',0.2);

% V = (0.65689224047432226 + 0.17799610627774348 .* x + 0.088632059399032931 .* y + 0.0023501249102540313 .* z + 0.20605743741392482 .* (x .* y) + 0.0047574968361556664 .* (x .* z) + 0.04010694720495888 .* (y .* z) + 0.7933959606226243 .* (x.^2) + 0.67379111463147245 .* (y.^2) + 0.039054713714198837 .* (z.^2));
% Vdot = ((( - 4.123991426359594 .* x - 23.646710430174462 .* y - 27.530004103469132 .* z + ((-842.38518808143465 .* (z.^3)) ./ 6) + 2 .* ((-724.55952735254027 .* y .* (z.^2)) ./ 6) + ((-724.55952735254016 .* y .* (z.^2)) ./ 6) + ((-623.20982967158932 .* (y.^2) .* z) ./ 6) + 2 .* ((-623.20982967158909 .* (y.^2) .* z) ./ 6) + ((-536.03281201954962 .* (y.^3)) ./ 6) + 2 .* ((-141.25061610207391 .* x .* (z.^2)) ./ 6) + ((-141.25061610207388 .* x .* (z.^2)) ./ 6) + 2 .* ((-121.42601259684383 .* x .* y .* z) ./ 6) + ((-121.42601259684379 .* x .* y .* z) ./ 6) + 3 .* ((-121.42601259684378 .* x .* y .* z) ./ 6) + 3 .* ((-104.38270636332155 .* x .* (y.^2)) ./ 6) + ((-91.078972005052165 .* (z.^2)) ./ 2) + 2 .* ((-77.930402411031281 .* y .* z) ./ 2) + ((-66.675806993664608 .* (y.^2)) ./ 2) + 2 .* ((-22.664038859713386 .* (x.^2) .* z) ./ 6) + ((-22.664038859713383 .* (x.^2) .* z) ./ 6) + 2 .* ((-19.466580820491501 .* (x.^2) .* y) ./ 6) + ((-19.466580820491497 .* (x.^2) .* y) ./ 6) + 2 .* ((-9.0992598875724564 .* x .* z) ./ 2) + ((-7.7221084999052971 .* x .* y) ./ 2) + ((-7.7221084999052962 .* x .* y) ./ 2) + ((-3.3868985363560489 .* (x.^3)) ./ 6) + ((0.049416654099535551 .* (x.^2)) ./ 2)) .* (0.0023501249102540313 + 0.0047574968361556664 .* x + 0.04010694720495888 .* y + 0.078109427428397674 .* z)) + (( - 2.3727308015319104 .* x + 0.55708911045314402 .* y + 0.10270492023415845 .* z + ((-7.531485227842035 .* (z.^2)) ./ 2) + ((-1.7855700002399373 .* (z.^3)) ./ 6) + 3 .* ((-0.55708911045314402 .* y .* (z.^2)) ./ 6) + 2 .* ((-0.055895353219691496 .* y .* z) ./ 2) + 2 .* ((0.23806716691875224 .* x .* z) ./ 2) + 3 .* ((2.3727308015319104 .* x .* (z.^2)) ./ 6)) .* (0.17799610627774348 + 1.5867919212452486 .* x + 0.20605743741392482 .* y + 0.0047574968361556664 .* z)) + (( - 0.23806716691875224 .* x + 0.055895353219691496 .* y + 7.4470603698588169 .* z + ((-7.6159100858252522 .* (z.^3)) ./ 6) + 2 .* ((-2.3727308015319104 .* x .* z) ./ 2) + 3 .* ((-0.055895353219691496 .* y .* (z.^2)) ./ 6) + 3 .* ((0.23806716691875224 .* x .* (z.^2)) ./ 6) + 2 .* ((0.55708911045314402 .* y .* z) ./ 2) + ((0.94413746023704781 .* (z.^2)) ./ 2)) .* (0.088632059399032931 + 0.20605743741392482 .* x + 1.3475822292629449 .* y + 0.04010694720495888 .* z)));
% surf(x,y,V, 'FaceAlpha',0.9); hold all;
% surf(x,y,Vdot, 'FaceAlpha',0.9);

V = ((17.44380596842316 - 12.234522841324672 .* x - 0.36990925123259 .* y + 35.111779142104666 .* z - 2.141779748825666 .* (x .* y) - 39.528495564423686 .* (x .* z) + 4.3101886346643914 .* (y .* z) + 7.3342138638670482 .* (x.^2) + 1.6947161611285289 .* (y.^2) + 56.52812895844248 .* (z.^2)) ./ 11.911054271629864);
surf(x,y,V, 'FaceAlpha',0.2); hold all;
pause
V = ((2.6294208247658575 - 2.2327980895286221 .* x - 10.477818807531179 .* y - 1.6692441363708104 .* z - 11.268145850144263 .* (x .* y) - 2.0915666668995048 .* (x .* z) + 4.8528345455883644 .* (y .* z) + 8.9592890532335385 .* (x.^2) + 17.795598413431172 .* (y.^2) + 4.0739959221681668 .* (z.^2)) ./ 9.9465365056775372);
surf(x,y,V, 'FaceAlpha',0.4); hold all;
pause
V = ((4.9819076134558848 + 0.0002736555077844089 .* x - 0.00072283457338696627 .* y - 0.00033497002921911701 .* z - 0.0045294634201237909 .* (x .* y) - 0.0030360203924140604 .* (x .* z) + 0.0033764492982834896 .* (y .* z) + 0.0021340106419911096 .* (x.^2) + 0.002622480998306297 .* (y.^2) + 0.0012440257077282256 .* (z.^2)) ./ 4.9816561860148134);
surf(x,y,V, 'FaceAlpha',0.6); hold all;
pause
V = (((x .* (1.5202439797896021 .* x + 0.075315350589800989 .* y - 0.0019881240501542496 .* z)) + (y .* (0.075315350589800989 .* x + 0.941983517587901 .* y + 0.016998960444918776 .* z)) + (z .* ( - 0.0019881240501542496 .* x + 0.016998960444918776 .* y + 0.043691485003206854 .* z))) ./ 0.58448082315910321);
surf(x,y,V, 'FaceAlpha',0.8); hold all;
pause
% axis([-2 2 -2 2 -1 1*2])

end

function xdot = car_dynamics(t,x, K, u, xd)
    xdot = 0*x;
    L = 1.0;
%     xdot(1) = (-2.2204460492503131e-16 - 2.8115338151280138 * (-3.1000000000000001 + x(1)) + 0.12467524917432853 * (-1.8999999999999999 + x(2)) + 0.29062218214616281 * (-0.10000000000000003 + x(3)) + ((-1.2312513831192315 * ((-0.10000000000000003 + x(3))^2)) / 2) + ((-1.1025926649111579 * ((-0.10000000000000003 + x(3))^3)) / 6) + 3 * ((-0.12467524917432853 * (-1.8999999999999999 + x(2)) * ((-0.10000000000000003 + x(3))^2)) / 6) + 2 * ((-0.012509250243078097 * (-1.8999999999999999 + x(2)) * (-0.10000000000000003 + x(3))) / 2) + 2 * ((0.28209432339802509 * (-3.1000000000000001 + x(1)) * (-0.10000000000000003 + x(3))) / 2) + 3 * ((2.8115338151280138 * (-3.1000000000000001 + x(1)) * ((-0.10000000000000003 + x(3))^2)) / 6));
%     xdot(2) = (-5.5511151231257827e-17 - 0.28209432339802509 * (-3.1000000000000001 + x(1)) + 0.012509250243078097 * (-1.8999999999999999 + x(2)) + 1.1905169870535861 * (-0.10000000000000003 + x(3)) + 2 * ((-2.8115338151280138 * (-3.1000000000000001 + x(1)) * (-0.10000000000000003 + x(3))) / 2) + ((-1.2719857791848768 * ((-0.10000000000000003 + x(3))^3)) / 6) + 3 * ((-0.012509250243078097 * (-1.8999999999999999 + x(2)) * ((-0.10000000000000003 + x(3))^2)) / 6) + 2 * ((0.12467524917432853 * (-1.8999999999999999 + x(2)) * (-0.10000000000000003 + x(3))) / 2) + 3 * ((0.28209432339802509 * (-3.1000000000000001 + x(1)) * ((-0.10000000000000003 + x(3))^2)) / 6) + ((0.69660742352866034 * ((-0.10000000000000003 + x(3))^2)) / 2));
%     xdot(3) = (-9.7699626167013776e-15 + 11.223240929675072 * (-3.1000000000000001 + x(1)) - 108.9957386471317 * (-1.8999999999999999 + x(2)) - 110.72125700558496 * (-0.10000000000000003 + x(3)) + ((-172832.12257904885 * ((-0.10000000000000003 + x(3))^3)) / 6) + ((-171787.77838502754 * (-1.8999999999999999 + x(2)) * ((-0.10000000000000003 + x(3))^2)) / 6) + ((-171787.77838502752 * (-1.8999999999999999 + x(2)) * ((-0.10000000000000003 + x(3))^2)) / 6) + ((-171787.77838502749 * (-1.8999999999999999 + x(2)) * ((-0.10000000000000003 + x(3))^2)) / 6) + ((-170745.56775913894 * ((-1.8999999999999999 + x(2))^2) * (-0.10000000000000003 + x(3))) / 6) + 2 * ((-170745.56775913891 * ((-1.8999999999999999 + x(2))^2) * (-0.10000000000000003 + x(3))) / 6) + ((-169705.48721974602 * ((-1.8999999999999999 + x(2))^3)) / 6) + ((-3554.9398598703192 * ((-0.10000000000000003 + x(3))^2)) / 2) + 2 * ((-3524.4550619080669 * (-1.8999999999999999 + x(2)) * (-0.10000000000000003 + x(3))) / 2) + ((-3494.0344345019516 * ((-1.8999999999999999 + x(2))^2)) / 2) + ((16.659002608308189 * ((-3.1000000000000001 + x(1))^2)) / 2) + ((35.363810762918718 * ((-3.1000000000000001 + x(1))^3)) / 6) + 2 * ((109.31752394940582 * (-3.1000000000000001 + x(1)) * (-0.10000000000000003 + x(3))) / 2) + ((110.3672990652795 * (-3.1000000000000001 + x(1)) * (-1.8999999999999999 + x(2))) / 2) + ((110.36729906527951 * (-3.1000000000000001 + x(1)) * (-1.8999999999999999 + x(2))) / 2) + 2 * ((419.22463058230051 * ((-3.1000000000000001 + x(1))^2) * (-0.10000000000000003 + x(3))) / 6) + ((419.22463058230062 * ((-3.1000000000000001 + x(1))^2) * (-0.10000000000000003 + x(3))) / 6) + 3 * ((420.41937577287842 * ((-3.1000000000000001 + x(1))^2) * (-1.8999999999999999 + x(2))) / 6) + 2 * ((904.53307719747136 * (-3.1000000000000001 + x(1)) * ((-0.10000000000000003 + x(3))^2)) / 6) + ((904.53307719747283 * (-3.1000000000000001 + x(1)) * ((-0.10000000000000003 + x(3))^2)) / 6) + 4 * ((941.14875949940506 * (-3.1000000000000001 + x(1)) * (-1.8999999999999999 + x(2)) * (-0.10000000000000003 + x(3))) / 6) + 2 * ((941.14875949940529 * (-3.1000000000000001 + x(1)) * (-1.8999999999999999 + x(2)) * (-0.10000000000000003 + x(3))) / 6) + 2 * ((977.68079947830392 * (-3.1000000000000001 + x(1)) * ((-1.8999999999999999 + x(2))^2)) / 6) + ((977.68079947830552 * (-3.1000000000000001 + x(1)) * ((-1.8999999999999999 + x(2))^2)) / 6));
    U = u - K * (x - xd);
    xdot(1) = U(2)*cos(x(3));
    xdot(2) = U(2)*sin(x(3));
    xdot(3) = U(2)/L*tan(U(1));
    xdot = xdot - [ 0.7934959 ,  0.84004339, -0.07974947]';
end

function xdot = car_approx_dynamics(t,x, xd)
    xdot = 0*x;
z = x(3) - xd(3);
y = x(2) - xd(2);
x = x(1) - xd(1);

xdot(1) = ( - 1.1159144301042365 .* x - 1.2916650636366902 .* y - 4.6513336792669584 .* z + ((-4.2355116495902401 .* (z.^2)) ./ 2) + 3 .* ((1.1159144301042365 .* x .* (z.^2)) ./ 6) + 2 .* ((1.181375414103512 .* x .* z) ./ 2) + 3 .* ((1.2916650636366902 .* y .* (z.^2)) ./ 6) + 2 .* ((1.3674358071472354 .* y .* z) ./ 2) + ((4.7545945270725447 .* (z.^3)) ./ 6));

xdot(2) = ( - 1.181375414103512 .* x - 1.3674358071472354 .* y + 4.2901707809474763 .* z + ((-4.7029641031697516 .* (z.^2)) ./ 2) + ((-4.1808525182330047 .* (z.^3)) ./ 6) + 2 .* ((-1.2916650636366902 .* y .* z) ./ 2) + 2 .* ((-1.1159144301042365 .* x .* z) ./ 2) + 3 .* ((1.181375414103512 .* x .* (z.^2)) ./ 6) + 3 .* ((1.3674358071472354 .* y .* (z.^2)) ./ 6));

xdot(3) = (159.454988473963 .* x - 184.73881356956988 .* y - 360.8431261775948 .* z + ((-363974.25493961625 .* (z.^3)) ./ 6) + 2 .* ((-191451.87749149723 .* y .* (z.^2)) ./ 6) + ((-191451.87749149717 .* y .* (z.^2)) ./ 6) + 2 .* ((-100684.41121734786 .* (y.^2) .* z) ./ 6) + ((-100684.41121734784 .* (y.^2) .* z) ./ 6) + 2 .* ((-67051.11285023237 .* (x.^2) .* z) ./ 6) + ((-67051.112850232355 .* (x.^2) .* z) ./ 6) + ((-52939.031620282018 .* (y.^3)) ./ 6) + 3 .* ((-35284.377609521187 .* (x.^2) .* y) ./ 6) + ((-9270.0144442840738 .* (z.^2)) ./ 2) + 2 .* ((-4839.7405260675714 .* y .* z) ./ 2) + ((-2525.56745270788 .* (y.^2)) ./ 2) + ((-1735.3461741839944 .* (x.^2)) ./ 2) + 2 .* ((2095.6456498505045 .* x .* y) ./ 2) + 2 .* ((4011.9357070107153 .* x .* z) ./ 2) + ((28768.636921901521 .* (x.^3)) ./ 6) + ((43238.992117300317 .* x .* (y.^2)) ./ 6) + 2 .* ((43238.992117300324 .* x .* (y.^2)) ./ 6) + 3 .* ((82200.608696781492 .* x .* y .* z) ./ 6) + 3 .* ((82200.608696781506 .* x .* y .* z) ./ 6) + ((156239.50270917031 .* x .* (z.^2)) ./ 6) + 2 .* ((156239.50270917034 .* x .* (z.^2)) ./ 6));

end

