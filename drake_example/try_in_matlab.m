%%
function try_in_matlab()
close all 
% clear all
clc

global times u x

times= [0.0, 0.18907862669528536, 0.3781572533905707, 0.5672358800858561, 0.7563145067811414, 0.9453931334764267, 1.134471760171712, 1.3235503868669973, 1.5126290135622826, 1.701707640257568, 1.8907862669528532, 2.0798648936481388, 2.268943520343424, 2.4580221470387094, 2.6471007737339947, 2.83617940042928, 3.0252580271245653, 3.2143366538198506, 3.403415280515136, 3.592493907210421, 3.7815725339057065, 3.9706511606009918, 4.1597297872962775, 4.348808413991563, 4.537887040686848, 4.726965667382133, 4.916044294077419, 5.105122920772704, 5.294201547467989, 5.483280174163275, 5.67235880085856];

u(1,:) = [1.04462876879715e-39, -1.7126314548119586, -2.9010794522115426, -3.102006055942472, -2.245217449509633, -0.6284117840469972, 1.221546536679045, 2.7058923733672615, 3.29586822109123, 2.7849522307288384, 1.430311081048632, -0.30558362070226136, -2.0018520162999556, -3.1783966781821733, -3.345411400350076, -2.506454785543622, -1.1683764383132946, 0.28573770262358333, 1.7532212617704606, 3.017114646427925, 3.504085138517881, 2.9690824098174433, 2.0006863261764534, 1.1881344160382263, 0.6583210461916044, 0.3340965213536019, 0.1227932539413686, -0.04759984773203472, -0.23896097319977264, -0.5227611435046724, 0.0];
    
x(1,:) = [0.0, -0.010000414394767999, -0.07225779264769361, -0.20255482410443806, -0.3618743870307576, -0.46935061987005305, -0.43914239397702026, -0.2231323253770166, 0.15227707183055558, 0.5762265925792176, 0.8976964790033167, 0.9899400688513925, 0.7789453298800719, 0.26477043253323557, -0.43055023083137706, -1.0843844692457276, -1.5097672841841137, -1.6172492508053076, -1.3585639006481807, -0.7063425072887632, 0.24591174638142171, 1.2183271480324656, 1.9658531698425696, 2.45163545587009, 2.7452221500867053, 2.918595918587861, 3.0210865267305955, 3.0825613861212977, 3.1195035615975955, 3.1384181470660426, 3.141592653589793];
x(2,:) = [0.0, -0.15610748701841248, -0.5191349869947877, -0.8238230087549628, -0.7863458093157538, -0.27020096567808216, 0.6366181983192326, 1.6276570780858892, 2.2423960256065727, 2.1024158129796233, 1.1834789629734195, -0.27491843679331585, -1.962978136988218, -3.3694848537450546, -3.7753377911025594, -2.969712215360361, -1.4564595603429877, 0.3599036782979895, 2.4094247752110984, 4.419490836590864, 5.3841361323538015, 4.668049846449325, 3.217941371104321, 1.9890167096750682, 1.1811972118728642, 0.695966015835621, 0.41417770532464937, 0.250517115323664, 0.14617264371897684, 0.05121429494828719, 6.071532165918825e-18];
     
     Q = 6*eye(3); R = 1*eye(2);
     
     S_all = []
     for i = 1:length(times)
         t=times(i); u0=u(:,i); x0=x(:,i);
         [A, B] = linearize_dynamics(t, x0, u0);
         [K,S,e] = lqr(A,B,Q,R);
         S_all(:,:,i) = S;
     end
     
     options = odeset('RelTol',1e-5,'Stats','on','OutputFcn',@odeplot);
     S0 = S_all(:,:,end);
     [T, Sode] = ode45(@(t,X)Sfunc(t, X, Q, R), fliplr(times), S0(:)) ;
     Sode = flipud(Sode);
     
     figure;
     [T, xcl] = ode45(@(t,x)my_cl_dynamics(t, x, Sode, inv(R)), ...
         times, x(:,1)+0.1*[rand(2,1); 0], options) ;
     figure;
     plot(xcl(:,1), xcl(:,2)); hold all
     plot(x(1,:), x(2,:));
end

function xdot = my_cl_dynamics(t, X, S, Rinv)
%     xdot = zeros(size(x));
global times u x
    L = 1;
    i = find(times>=t, 1, 'first');
    
    [~, B] = linearize_dynamics(times(i), x(:,i), u(:,i));
    
    Si = reshape(S(i, :), 3, 3);
    K = Rinv*B'*Si;
    
    xdot = my_poly_dynamics(t, X, u(:,i) - K*(X-x(:,i)) );% + ...
           %my_dynamics(t, x(:,i), u(:,i)); %
end

function xdot = my_poly_dynamics(t, x, u)
    xdot = zeros(size(x));
    L = 1;
    
    xdot(1) = u(2)*(1.0 - (x(3)^2)/2.0 + (x(3)^4)/24.0);
    xdot(2) = u(2)*(x(3) - (x(3)^3)/6.0);
    xdot(3) = u(2)/L*(u(1) + (u(1)^3)/3.0);
end

function xdot = my_dynamics(t, x, u)
    xdot = zeros(size(x));
    L = 1;
    
    xdot(1) = u(2)*cos(x(3));
    xdot(2) = u(2)*sin(x(3));
    xdot(3) = u(2)/L*tan(u(1));
end


function [A, B] = linearize_dynamics(t, x, u)
    L = 1; g = 10; c= 0.1;
    
    A = [0, 1; ...
         -g/L*cos(x(1)),  -c*x(2)];
    B = [0 ; 1];
    
%     A = [0 0 -u(2)*sin(x(3)); ...
%          0 0  u(2)*cos(x(3)); ...
%          0 0 0];
%     B = [0 cos(x(3)) ; ...
%          0 sin(x(3)) ; ...
%          u(2)*(1+tan(u(1))^2)/L tan(u(1))/L ];
end

function [Sdot, isterminal, direction] = Sfunc(t, S, Q, R)
global times x u

 i = find(times>=t, 1, 'first');
 [A, B] = linearize_dynamics(times(i), x(:,i), u(:,i));
 
 S = reshape(S, size(A)); % Vector to matrix
 Sdot = -(A'*S + S*A - S*B*inv(R)*B'*S + Q); % Values is the derivative of X
 Sdot = Sdot(:); % Turn value to a vector

 isterminal = 1;   % Stop the integration - An event!  
 direction  = 0;
end

