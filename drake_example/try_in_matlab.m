%%
function try_in_matlab()
close all 
% clear all
clc

global times u x

times= [0.        , 0.02636494, 0.05272988, 0.07909482, 0.10545977, ...
       0.13182471, 0.15818965, 0.18455459, 0.21091953, 0.23728447, ...
       0.26364942, 0.29001436, 0.3163793 , 0.34274424, 0.36910918, ...
       0.39547412, 0.42183907, 0.44820401, 0.47456895, 0.50093389, ...
       0.52729883, 0.55366377, 0.58002871, 0.60639366, 0.6327586 , ...
       0.65912354, 0.68548848, 0.71185342, 0.73821836, 0.76458331, ...
       0.79094825, 0.81731319, 0.84367813, 0.87004307, 0.89640801, ...
       0.92277295, 0.9491379 , 0.97550284, 1.00186778, 1.02823272, ...
       1.05459766, 1.0809626 , 1.10732755, 1.13369249, 1.16005743, ...
       1.18642237, 1.21278731, 1.23915225, 1.2655172 , 1.29188214, ...
       1.31824708, 1.34461202, 1.37097696, 1.3973419 , 1.42370684, ...
       1.45007179, 1.47643673, 1.50280167, 1.52916661, 1.55553155, ...
       1.58189649, 1.60826144, 1.63462638, 1.66099132, 1.68735626, ...
       1.7137212 , 1.74008614, 1.76645108, 1.79281603, 1.81918097, ...
       1.84554591, 1.87191085, 1.89827579, 1.92464073, 1.95100568, ...
       1.97737062, 2.00373556, 2.0301005 , 2.05646544, 2.08283038, ...
       2.10919533, 2.13556027, 2.16192521, 2.18829015, 2.21465509, ...
       2.24102003, 2.26738497, 2.29374992, 2.32011486, 2.3464798 , ...
       2.37284474, 2.39920968, 2.42557462, 2.45193957, 2.47830451, ...
       2.50466945, 2.53103439, 2.55739933, 2.58376427, 2.61012921];

u(1,:) = [-0.52359878, -0.52359878, -0.52359878, -0.52359878, -0.52359878, ...
        -0.52359878, -0.52359878, -0.52359878, -0.52359878, -0.52359878, ...
        -0.52359878, -0.52359878, -0.52359878, -0.52359878, -0.52359878, ...
        -0.49186552, -0.28031046, -0.06875539,  0.14279967,  0.35435473, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.52359878,  0.52359878,  0.52359878,  0.52359878,  0.52359878, ...
         0.35435473,  0.14279967, -0.06875539, -0.28031046, -0.49186552, ...
        -0.52359878, -0.52359878, -0.52359878, -0.52359878, -0.52359878, ...
        -0.52359878, -0.52359878, -0.52359878, -0.52359878, -0.52359878, ...
        -0.52359878, -0.52359878, -0.52359878, -0.52359878, -0.52359878];
u(2,:)= [-0.85150476, -0.85150484, -0.85150491, -0.85150499, -0.85150507, ...
        -0.85150518, -0.85150596, -0.85150674, -0.85150753, -0.85150831, ...
        -0.84415824, -0.77065052, -0.69714279, -0.62363507, -0.55012734, ...
        -0.44352589, -0.14939336,  0.14473917,  0.4388717 ,  0.73300424, ...
         0.98299146,  1.05639744,  1.12980342,  1.2032094 ,  1.27661538, ...
         1.3316702 ,  1.33167154,  1.33167288,  1.33167422,  1.33167556, ...
         1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 , ...
         1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 , ...
         1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 , ...
         1.3316765 ,  1.3316765 ,  1.3316765 ,  1.33167649,  1.33167649, ...
         1.33167649,  1.33167649,  1.3316765 ,  1.3316765 ,  1.3316765 , ...
         1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 , ...
         1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 , ...
         1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 ,  1.3316765 , ...
         1.33167556,  1.33167422,  1.33167288,  1.33167154,  1.3316702 , ...
         1.27661538,  1.2032094 ,  1.12980342,  1.05639744,  0.98299146, ...
         0.73300424,  0.4388717 ,  0.14473917, -0.14939336, -0.44352589, ...
        -0.55012734, -0.62363507, -0.69714279, -0.77065052, -0.84415824, ...
        -0.85150831, -0.85150753, -0.85150674, -0.85150596, -0.85150518, ...
        -0.85150507, -0.85150499, -0.85150491, -0.85150484, -0.85150476];
    
x(1,:) = [ 0.00000000e+00, -1.59769122e-02, -3.21568998e-02, ...
        -4.85372119e-02, -6.51150979e-02, -8.18878070e-02, ...
        -9.88525632e-02, -1.16006484e-01, -1.33346660e-01, ...
        -1.50870180e-01, -1.68566405e-01, -1.85513628e-01, ...
        -2.01053868e-01, -2.15150677e-01, -2.27767602e-01, ...
        -2.38814373e-01, -2.45252202e-01, -2.45315456e-01, ...
        -2.38966693e-01, -2.26168471e-01, -2.06977320e-01, ...
        -1.84455214e-01, -1.60061748e-01, -1.33752139e-01, ...
        -1.05481598e-01, -7.52585155e-02, -4.42229719e-02, ...
        -1.28610939e-02,  1.88141415e-02,  5.07897577e-02, ...
         8.30527719e-02,  1.15589955e-01,  1.48387778e-01, ...
         1.81432699e-01,  2.14711174e-01,  2.48209655e-01, ...
         2.81914401e-01,  3.15811450e-01,  3.49886830e-01, ...
         3.84126571e-01,  4.18516692e-01,  4.53043068e-01, ...
         4.87691441e-01,  5.22447549e-01,  5.57297134e-01, ...
         5.92225927e-01,  6.27219569e-01,  6.62263651e-01, ...
         6.97343769e-01,  7.32445516e-01,  7.67554484e-01, ...
         8.02656231e-01,  8.37736349e-01,  8.72780431e-01, ...
         9.07774073e-01,  9.42702866e-01,  9.77552451e-01, ...
         1.01230856e+00,  1.04695693e+00,  1.08148331e+00, ...
         1.11587343e+00,  1.15011317e+00,  1.18418855e+00, ...
         1.21808560e+00,  1.25179034e+00,  1.28528883e+00, ...
         1.31856730e+00,  1.35161222e+00,  1.38441004e+00, ...
         1.41694723e+00,  1.44921024e+00,  1.48118586e+00, ...
         1.51286109e+00,  1.54422297e+00,  1.57525852e+00, ...
         1.60548160e+00,  1.63375214e+00,  1.66006175e+00, ...
         1.68445521e+00,  1.70697732e+00,  1.72616847e+00, ...
         1.73896669e+00,  1.74531546e+00,  1.74525220e+00, ...
         1.73881437e+00,  1.72776760e+00,  1.71515068e+00, ...
         1.70105387e+00,  1.68551363e+00,  1.66856640e+00, ...
         1.65087018e+00,  1.63334666e+00,  1.61600648e+00, ...
         1.59885256e+00,  1.58188781e+00,  1.56511510e+00, ...
         1.54853721e+00,  1.53215690e+00,  1.51597691e+00, 1.50000000e+00];
x(2,:) = [ 0.00000000e+00,  1.57711143e-02,  3.13338221e-02, ...
         4.66855437e-02,  6.18236991e-02,  7.67457085e-02, ...
         9.14490322e-02,  1.05931250e-01,  1.20189962e-01, ...
         1.34222771e-01,  1.48021411e-01,  1.60901270e-01, ...
         1.72427356e-01,  1.82646423e-01,  1.91605220e-01, ...
         1.99313313e-01,  2.03745211e-01,  2.03760997e-01, ...
         1.99415812e-01,  1.90764799e-01,  1.77931768e-01, ...
         1.63246674e-01,  1.47895986e-01,  1.31971379e-01, ...
         1.15564532e-01,  9.87964697e-02,  8.23823273e-02, ...
         6.66005515e-02,  5.14574377e-02,  3.69592811e-02, ...
         2.31123725e-02,  9.92255924e-03, -2.60511291e-03, ...
        -1.44656822e-02, -2.56541868e-02, -3.61656740e-02, ...
        -4.59957092e-02, -5.51406462e-02, -6.35969047e-02, ...
        -7.13609045e-02, -7.84290798e-02, -8.47984468e-02, ...
        -9.04667900e-02, -9.54319468e-02, -9.96917547e-02, ...
        -1.03244072e-01, -1.06087400e-01, -1.08220972e-01, ...
        -1.09644068e-01, -1.10355962e-01, -1.10355962e-01, ...
        -1.09644068e-01, -1.08220972e-01, -1.06087400e-01, ...
        -1.03244072e-01, -9.96917547e-02, -9.54319468e-02, ...
        -9.04667900e-02, -8.47984468e-02, -7.84290798e-02, ...
        -7.13609045e-02, -6.35969047e-02, -5.51406462e-02, ...
        -4.59957092e-02, -3.61656740e-02, -2.56541868e-02, ...
        -1.44656822e-02, -2.60511291e-03,  9.92255924e-03, ...
         2.31123725e-02,  3.69592811e-02,  5.14574377e-02, ...
         6.66005515e-02,  8.23823273e-02,  9.87964697e-02, ...
         1.15564532e-01,  1.31971379e-01,  1.47895986e-01, ...
         1.63246674e-01,  1.77931768e-01,  1.90764799e-01, ...
         1.99415812e-01,  2.03760997e-01,  2.03745211e-01, ...
         1.99313313e-01,  1.91605220e-01,  1.82646423e-01, ...
         1.72427356e-01,  1.60901270e-01,  1.48021411e-01, ...
         1.34222771e-01,  1.20189962e-01,  1.05931250e-01, ...
         9.14490322e-02,  7.67457085e-02,  6.18236991e-02, ...
         4.66855437e-02,  3.13338221e-02,  1.57711143e-02, -8.80914265e-20];
x(3,:)= [-7.85398163e-01, -7.72436722e-01, -7.59475280e-01,  ...
        -7.46513836e-01, -7.33552391e-01, -7.20590946e-01, ...
        -7.07629493e-01, -6.94668028e-01, -6.81706551e-01, ...
        -6.68745062e-01, -6.55789156e-01, -6.43499003e-01, ...
        -6.32327770e-01, -6.22275458e-01, -6.13342066e-01, ...
        -6.05597080e-01, -6.02118821e-01, -6.01956265e-01, ...
        -6.01491449e-01, -5.97106412e-01, -5.85374318e-01, ...
        -5.69852726e-01, -5.53213763e-01, -5.35457428e-01, ...
        -5.16583722e-01, -4.96627561e-01, -4.76357125e-01, ...
        -4.56086669e-01, -4.35816191e-01, -4.15545694e-01, ...
        -3.95275177e-01, -3.75004655e-01, -3.54734133e-01, ...
        -3.34463611e-01, -3.14193089e-01, -2.93922568e-01, ...
        -2.73652046e-01, -2.53381524e-01, -2.33111001e-01, ...
        -2.12840480e-01, -1.92569958e-01, -1.72299436e-01, ...
        -1.52028914e-01, -1.31758392e-01, -1.11487870e-01, ...
        -9.12173486e-02, -7.09468268e-02, -5.06763047e-02, ...
        -3.04057826e-02, -1.01352608e-02,  1.01352608e-02, ...
         3.04057826e-02,  5.06763047e-02,  7.09468268e-02, ...
         9.12173486e-02,  1.11487870e-01,  1.31758392e-01, ...
         1.52028914e-01,  1.72299436e-01,  1.92569958e-01, ...
         2.12840480e-01,  2.33111001e-01,  2.53381524e-01, ...
         2.73652046e-01,  2.93922568e-01,  3.14193089e-01, ...
         3.34463611e-01,  3.54734133e-01,  3.75004655e-01, ...
         3.95275177e-01,  4.15545694e-01,  4.35816191e-01, ...
         4.56086669e-01,  4.76357125e-01,  4.96627561e-01, ...
         5.16583722e-01,  5.35457428e-01,  5.53213763e-01, ...
         5.69852726e-01,  5.85374318e-01,  5.97106412e-01, ...
         6.01491449e-01,  6.01956265e-01,  6.02118821e-01, ...
         6.05597080e-01,  6.13342066e-01,  6.22275458e-01, ...
         6.32327770e-01,  6.43499003e-01,  6.55789156e-01, ...
         6.68745062e-01,  6.81706551e-01,  6.94668028e-01, ...
         7.07629493e-01,  7.20590946e-01,  7.33552391e-01, ...
         7.46513836e-01,  7.59475280e-01,  7.72436722e-01, 7.85398163e-01];
     
     Q = 3*eye(3); R = 1*eye(2);
     
     S_all = []
     for i = 1:length(times)
         t=times(i); u0=u(:,i); x0=x(:,i);
         [A, B] = linearize_dynamics(t, x0, u0);
         [K,S,e] = lqr(A,B,Q,R);
         S_all(:,:,i) = S;
     end
     
     options = odeset('RelTol',1e-5,'Stats','on','OutputFcn',@odeplot);
     S0 = S_all(:,:,end);
     [T, Sode] = ode45(@(t,X)Sfunc(t, X, Q, R), fliplr(times), S0(:)) ;
     Sode = flipud(Sode);
     
     figure;
     [T, xcl] = ode45(@(t,x)my_cl_dynamics(t, x, Sode, inv(R)), ...
         times, x(:,1)+0.1*[rand(2,1); 0], options) ;
     figure;
     plot(xcl(:,1), xcl(:,2)); hold all
     plot(x(1,:), x(2,:));
end

function xdot = my_cl_dynamics(t, X, S, Rinv)
%     xdot = zeros(size(x));
global times u x
    L = 1;
    i = find(times>=t, 1, 'first');
    
    [~, B] = linearize_dynamics(times(i), x(:,i), u(:,i));
    
    Si = reshape(S(i, :), 3, 3);
    K = Rinv*B'*Si;
    
    xdot = my_poly_dynamics(t, X, u(:,i) - K*(X-x(:,i)) );% + ...
           %my_dynamics(t, x(:,i), u(:,i)); %
end

function xdot = my_poly_dynamics(t, x, u)
    xdot = zeros(size(x));
    L = 1;
    
    xdot(1) = u(2)*(1.0 - (x(3)^2)/2.0 + (x(3)^4)/24.0);
    xdot(2) = u(2)*(x(3) - (x(3)^3)/6.0);
    xdot(3) = u(2)/L*(u(1) + (u(1)^3)/3.0);
end

function xdot = my_dynamics(t, x, u)
    xdot = zeros(size(x));
    L = 1;
    
    xdot(1) = u(2)*cos(x(3));
    xdot(2) = u(2)*sin(x(3));
    xdot(3) = u(2)/L*tan(u(1));
end


function [A, B] = linearize_dynamics(t, x, u)
    L = 1;
    A = [0 0 -u(2)*sin(x(3)); ...
         0 0  u(2)*cos(x(3)); ...
         0 0 0];
    B = [0 cos(x(3)) ; ...
         0 sin(x(3)) ; ...
         u(2)*(1+tan(u(1))^2)/L tan(u(1))/L ];
end

function [Sdot, isterminal, direction] = Sfunc(t, S, Q, R)
global times x u

 i = find(times>=t, 1, 'first');
 [A, B] = linearize_dynamics(times(i), x(:,i), u(:,i));
 
 S = reshape(S, size(A)); % Vector to matrix
 Sdot = -(A'*S + S*A - S*B*inv(R)*B'*S + Q); % Values is the derivative of X
 Sdot = Sdot(:); % Turn value to a vector

 isterminal = 1;   % Stop the integration - An event!  
 direction  = 0;
end

