function final_point_control_check()
close all
times=0:0.01:10;

xf =[3.1, 1.9, 0.1]';
T = eye(3); 
% T = [-0.08434561,  0.00531625;
%       0.25015733,  0.20463393];
xf = T*xf;
uf = [-1.3962634 ,  1.15555556]';
R = 0.5;
x0 = xf+R*[2*(rand(size(xf))-.5);];
figure;
% A = [0, 1; -10*cos(xf(1)) -1]; B = [0;1];
% [K,~,~]= lqr(A,B,10*eye(2),1*eye(1));
K = [ 0.12530123,  2.8256503 ,  2.82883696; ...
      2.8256503 , -0.12530123, -0.40802366];
options = odeset('RelTol',1e-5,'Stats','on','OutputFcn',@odeplot);
[T, x] = ode45(@(t,x)car_dynamics(t, x, K, uf, xf), ...
                    times, x0, options) ;

plot(T, x(:,1),'b-', T, x(:,2), 'g-', T, x(:,3), 'r-'); hold all;
plot([T(1) T(end)], [xf(1) xf(1)], 'b');
plot([T(1) T(end)], [xf(2) xf(2)], 'g');
plot([T(1) T(end)], [xf(3) xf(3)], 'r');
% V = (((-3.1000000000000001 + x(:,1)) .* (1.4837669049548923 .* (-3.1000000000000001 + x(:,1)) - 0.54459785166515851 .* (-1.8999999999999999 + x(:,2)) + 0.0016067430675332931 .* (-0.10000000000000003 + x(:,3)))) + ((-1.8999999999999999 + x(:,2)) .* ( - 0.54459785166515862 .* (-3.1000000000000001 + x(:,1)) + 6.9054387378206794 .* (-1.8999999999999999 + x(:,2)) + 0.036868266945400185 .* (-0.10000000000000003 + x(:,3)))) + ((-0.10000000000000003 + x(:,3)) .* (0.0016067430675332939 .* (-3.1000000000000001 + x(:,1)) + 0.036868266945400185 .* (-1.8999999999999999 + x(:,2)) + 0.036527396478655862 .* (-0.10000000000000003 + x(:,3)))));
% plot(T, V);

% figure;
% [x, y] = meshgrid(1:0.1:5, 1:0.1:3);
% t = xf(3)*ones(size(x));
% V = (((-3.1000000000000001 + x) .* (1.4837669049548923 .* (-3.1000000000000001 + x) - 0.54459785166515851 .* (-1.8999999999999999 + y) + 0.0016067430675332931 .* (-0.10000000000000003 + t))) + ((-1.8999999999999999 + y) .* ( - 0.54459785166515862 .* (-3.1000000000000001 + x) + 6.9054387378206794 .* (-1.8999999999999999 + y) + 0.036868266945400185 .* (-0.10000000000000003 + t))) + ((-0.10000000000000003 + t) .* (0.0016067430675332939 .* (-3.1000000000000001 + x) + 0.036868266945400185 .* (-1.8999999999999999 + y) + 0.036527396478655862 .* (-0.10000000000000003 + t))));
% Vdot = (((-6.5534812137804597 + 11.223240929675072 .* (-3.1000000000000001 + x) - 108.9957386471317 .* (-1.8999999999999999 + y) - 110.72125700558496 .* (-0.10000000000000003 + t) + ((-172832.12257904885 .* ((-0.10000000000000003 + t).^3)) ./ 6) + ((-171787.77838502754 .* (-1.8999999999999999 + y) .* ((-0.10000000000000003 + t).^2)) ./ 6) + ((-171787.77838502752 .* (-1.8999999999999999 + y) .* ((-0.10000000000000003 + t).^2)) ./ 6) + ((-171787.77838502749 .* (-1.8999999999999999 + y) .* ((-0.10000000000000003 + t).^2)) ./ 6) + ((-170745.56775913894 .* ((-1.8999999999999999 + y).^2) .* (-0.10000000000000003 + t)) ./ 6) + 2 .* ((-170745.56775913891 .* ((-1.8999999999999999 + y).^2) .* (-0.10000000000000003 + t)) ./ 6) + ((-169705.48721974602 .* ((-1.8999999999999999 + y).^3)) ./ 6) + ((-3554.9398598703192 .* ((-0.10000000000000003 + t).^2)) ./ 2) + 2 .* ((-3524.4550619080669 .* (-1.8999999999999999 + y) .* (-0.10000000000000003 + t)) ./ 2) + ((-3494.0344345019516 .* ((-1.8999999999999999 + y).^2)) ./ 2) + ((16.659002608308189 .* ((-3.1000000000000001 + x).^2)) ./ 2) + ((35.363810762918718 .* ((-3.1000000000000001 + x).^3)) ./ 6) + 2 .* ((109.31752394940582 .* (-3.1000000000000001 + x) .* (-0.10000000000000003 + t)) ./ 2) + ((110.3672990652795 .* (-3.1000000000000001 + x) .* (-1.8999999999999999 + y)) ./ 2) + ((110.36729906527951 .* (-3.1000000000000001 + x) .* (-1.8999999999999999 + y)) ./ 2) + 2 .* ((419.22463058230051 .* ((-3.1000000000000001 + x).^2) .* (-0.10000000000000003 + t)) ./ 6) + ((419.22463058230062 .* ((-3.1000000000000001 + x).^2) .* (-0.10000000000000003 + t)) ./ 6) + 3 .* ((420.41937577287842 .* ((-3.1000000000000001 + x).^2) .* (-1.8999999999999999 + y)) ./ 6) + 2 .* ((904.53307719747136 .* (-3.1000000000000001 + x) .* ((-0.10000000000000003 + t).^2)) ./ 6) + ((904.53307719747283 .* (-3.1000000000000001 + x) .* ((-0.10000000000000003 + t).^2)) ./ 6) + 4 .* ((941.14875949940506 .* (-3.1000000000000001 + x) .* (-1.8999999999999999 + y) .* (-0.10000000000000003 + t)) ./ 6) + 2 .* ((941.14875949940529 .* (-3.1000000000000001 + x) .* (-1.8999999999999999 + y) .* (-0.10000000000000003 + t)) ./ 6) + 2 .* ((977.68079947830392 .* (-3.1000000000000001 + x) .* ((-1.8999999999999999 + y).^2)) ./ 6) + ((977.68079947830552 .* (-3.1000000000000001 + x) .* ((-1.8999999999999999 + y).^2)) ./ 6)) .* (0.003213486135066587 .* (-3.1000000000000001 + x) + 0.073736533890800371 .* (-1.8999999999999999 + y) + 0.073054792957311723 .* (-0.10000000000000003 + t))) + (( - 1.0891957033303172 .* (-3.1000000000000001 + x) + 13.810877475641359 .* (-1.8999999999999999 + y) + 0.073736533890800371 .* (-0.10000000000000003 + t)) .* (0.11536305923633483 - 0.28209432339802509 .* (-3.1000000000000001 + x) + 0.012509250243078097 .* (-1.8999999999999999 + y) + 1.1905169870535861 .* (-0.10000000000000003 + t) + 2 .* ((-2.8115338151280138 .* (-3.1000000000000001 + x) .* (-0.10000000000000003 + t)) ./ 2) + ((-1.2719857791848768 .* ((-0.10000000000000003 + t).^3)) ./ 6) + 3 .* ((-0.012509250243078097 .* (-1.8999999999999999 + y) .* ((-0.10000000000000003 + t).^2)) ./ 6) + 2 .* ((0.12467524917432853 .* (-1.8999999999999999 + y) .* (-0.10000000000000003 + t)) ./ 2) + 3 .* ((0.28209432339802509 .* (-3.1000000000000001 + x) .* ((-0.10000000000000003 + t).^2)) ./ 6) + ((0.69660742352866034 .* ((-0.10000000000000003 + t).^2)) ./ 2))) + ((2.9675338099097845 .* (-3.1000000000000001 + x) - 1.0891957033303172 .* (-1.8999999999999999 + y) + 0.003213486135066587 .* (-0.10000000000000003 + t)) .* (1.1497825909879409 - 2.8115338151280138 .* (-3.1000000000000001 + x) + 0.12467524917432853 .* (-1.8999999999999999 + y) + 0.29062218214616281 .* (-0.10000000000000003 + t) + ((-1.2312513831192315 .* ((-0.10000000000000003 + t).^2)) ./ 2) + ((-1.1025926649111579 .* ((-0.10000000000000003 + t).^3)) ./ 6) + 3 .* ((-0.12467524917432853 .* (-1.8999999999999999 + y) .* ((-0.10000000000000003 + t).^2)) ./ 6) + 2 .* ((-0.012509250243078097 .* (-1.8999999999999999 + y) .* (-0.10000000000000003 + t)) ./ 2) + 2 .* ((0.28209432339802509 .* (-3.1000000000000001 + x) .* (-0.10000000000000003 + t)) ./ 2) + 3 .* ((2.8115338151280138 .* (-3.1000000000000001 + x) .* ((-0.10000000000000003 + t).^2)) ./ 6))));
% surf(x,y,V); hold all;
% surf(x,y,Vdot);
% 
% axis([1 5 1 3 -1 1*2])

end

function xdot = car_dynamics(t,x, K, u, xd)
    xdot = 0*x;
    L = 1.0;
%     xdot(1) = (-2.2204460492503131e-16 - 2.8115338151280138 * (-3.1000000000000001 + x(1)) + 0.12467524917432853 * (-1.8999999999999999 + x(2)) + 0.29062218214616281 * (-0.10000000000000003 + x(3)) + ((-1.2312513831192315 * ((-0.10000000000000003 + x(3))^2)) / 2) + ((-1.1025926649111579 * ((-0.10000000000000003 + x(3))^3)) / 6) + 3 * ((-0.12467524917432853 * (-1.8999999999999999 + x(2)) * ((-0.10000000000000003 + x(3))^2)) / 6) + 2 * ((-0.012509250243078097 * (-1.8999999999999999 + x(2)) * (-0.10000000000000003 + x(3))) / 2) + 2 * ((0.28209432339802509 * (-3.1000000000000001 + x(1)) * (-0.10000000000000003 + x(3))) / 2) + 3 * ((2.8115338151280138 * (-3.1000000000000001 + x(1)) * ((-0.10000000000000003 + x(3))^2)) / 6));
%     xdot(2) = (-5.5511151231257827e-17 - 0.28209432339802509 * (-3.1000000000000001 + x(1)) + 0.012509250243078097 * (-1.8999999999999999 + x(2)) + 1.1905169870535861 * (-0.10000000000000003 + x(3)) + 2 * ((-2.8115338151280138 * (-3.1000000000000001 + x(1)) * (-0.10000000000000003 + x(3))) / 2) + ((-1.2719857791848768 * ((-0.10000000000000003 + x(3))^3)) / 6) + 3 * ((-0.012509250243078097 * (-1.8999999999999999 + x(2)) * ((-0.10000000000000003 + x(3))^2)) / 6) + 2 * ((0.12467524917432853 * (-1.8999999999999999 + x(2)) * (-0.10000000000000003 + x(3))) / 2) + 3 * ((0.28209432339802509 * (-3.1000000000000001 + x(1)) * ((-0.10000000000000003 + x(3))^2)) / 6) + ((0.69660742352866034 * ((-0.10000000000000003 + x(3))^2)) / 2));
%     xdot(3) = (-9.7699626167013776e-15 + 11.223240929675072 * (-3.1000000000000001 + x(1)) - 108.9957386471317 * (-1.8999999999999999 + x(2)) - 110.72125700558496 * (-0.10000000000000003 + x(3)) + ((-172832.12257904885 * ((-0.10000000000000003 + x(3))^3)) / 6) + ((-171787.77838502754 * (-1.8999999999999999 + x(2)) * ((-0.10000000000000003 + x(3))^2)) / 6) + ((-171787.77838502752 * (-1.8999999999999999 + x(2)) * ((-0.10000000000000003 + x(3))^2)) / 6) + ((-171787.77838502749 * (-1.8999999999999999 + x(2)) * ((-0.10000000000000003 + x(3))^2)) / 6) + ((-170745.56775913894 * ((-1.8999999999999999 + x(2))^2) * (-0.10000000000000003 + x(3))) / 6) + 2 * ((-170745.56775913891 * ((-1.8999999999999999 + x(2))^2) * (-0.10000000000000003 + x(3))) / 6) + ((-169705.48721974602 * ((-1.8999999999999999 + x(2))^3)) / 6) + ((-3554.9398598703192 * ((-0.10000000000000003 + x(3))^2)) / 2) + 2 * ((-3524.4550619080669 * (-1.8999999999999999 + x(2)) * (-0.10000000000000003 + x(3))) / 2) + ((-3494.0344345019516 * ((-1.8999999999999999 + x(2))^2)) / 2) + ((16.659002608308189 * ((-3.1000000000000001 + x(1))^2)) / 2) + ((35.363810762918718 * ((-3.1000000000000001 + x(1))^3)) / 6) + 2 * ((109.31752394940582 * (-3.1000000000000001 + x(1)) * (-0.10000000000000003 + x(3))) / 2) + ((110.3672990652795 * (-3.1000000000000001 + x(1)) * (-1.8999999999999999 + x(2))) / 2) + ((110.36729906527951 * (-3.1000000000000001 + x(1)) * (-1.8999999999999999 + x(2))) / 2) + 2 * ((419.22463058230051 * ((-3.1000000000000001 + x(1))^2) * (-0.10000000000000003 + x(3))) / 6) + ((419.22463058230062 * ((-3.1000000000000001 + x(1))^2) * (-0.10000000000000003 + x(3))) / 6) + 3 * ((420.41937577287842 * ((-3.1000000000000001 + x(1))^2) * (-1.8999999999999999 + x(2))) / 6) + 2 * ((904.53307719747136 * (-3.1000000000000001 + x(1)) * ((-0.10000000000000003 + x(3))^2)) / 6) + ((904.53307719747283 * (-3.1000000000000001 + x(1)) * ((-0.10000000000000003 + x(3))^2)) / 6) + 4 * ((941.14875949940506 * (-3.1000000000000001 + x(1)) * (-1.8999999999999999 + x(2)) * (-0.10000000000000003 + x(3))) / 6) + 2 * ((941.14875949940529 * (-3.1000000000000001 + x(1)) * (-1.8999999999999999 + x(2)) * (-0.10000000000000003 + x(3))) / 6) + 2 * ((977.68079947830392 * (-3.1000000000000001 + x(1)) * ((-1.8999999999999999 + x(2))^2)) / 6) + ((977.68079947830552 * (-3.1000000000000001 + x(1)) * ((-1.8999999999999999 + x(2))^2)) / 6));
    U = u - K * (x - xd);
    xdot(1) = U(2)*cos(x(3));
    xdot(2) = U(2)*sin(x(3));
    xdot(3) = U(2)/L*tan(U(1));
end

function xdot = pendulum_full_dynamics(t,x, K)
    xdot = 0*x;
%     u = -[0.48808848, 3.31303139] * ([x(1); x(2)] - [pi; 0]);
%     u=0;
    u = -K * ([x(1); x(2)] - [pi; 0]);
    xdot(1) = x(2);
    xdot(2) = (u - 10*sin(x(1)) );
end

function xdot = the_dynamics(t, x)
    xdot = x;

    xdot(1) = (( - 1.7996170331373038 * (-1.4999999999999998 + x(1)) - 0.614088168801185 * (-0.78539816339744839 + x(3)) - 2.6002650891865011 * (6.9388939039072284e-18 + x(2))) * (0.70710678118654746 - 0.70710678118654757 * (-0.78539816339744839 + x(3)) - ((0.70710678118654746 * ((-0.78539816339744839 + x(3))^2)) / 2) + ((0.70710678118654746 * ((-0.78539816339744839 + x(3))^4)) / 24) + ((0.70710678118654757 * ((-0.78539816339744839 + x(3))^3)) / 6)));
    xdot(2) = (( - 1.7996170331373038 * (-1.4999999999999998 + x(1)) - 0.614088168801185 * (-0.78539816339744839 + x(3)) - 2.6002650891865011 * (6.9388939039072284e-18 + x(2))) * (0.70710678118654757 + 0.70710678118654746 * (-0.78539816339744839 + x(3)) - ((0.70710678118654746 * ((-0.78539816339744839 + x(3))^3)) / 6) - ((0.70710678118654757 * ((-0.78539816339744839 + x(3))^2)) / 2)));
    xdot(3) = (( - 1.7996170331373038 * (-1.4999999999999998 + x(1)) - 0.614088168801185 * (-0.78539816339744839 + x(3)) - 2.6002650891865011 * (6.9388939039072284e-18 + x(2))) * (2.600265089186502 * (-1.4999999999999998 + x(1)) - 3.7801687063692455 * (-0.78539816339744839 + x(3)) - 1.7996170331373023 * (6.9388939039072284e-18 + x(2)) + ((2 * ((2.600265089186502 * (-1.4999999999999998 + x(1)) - 3.7801687063692455 * (-0.78539816339744839 + x(3)) - 1.7996170331373023 * (6.9388939039072284e-18 + x(2)))^3)) / 6)));
    
end


function xdot = approx_dynamics(t,x,x_d)
    xdot = x;
    L=1;
    u_d = [0;0];
    K = [-2.60026509,  1.79961703,  3.78016871; ...
          1.79961703,  2.60026509,  0.61408817];

    
    U = u_d - K*(x-x_d); 
	delta_fb = U(1);
	u_fb = U(2);
	theta = x(3);
            
%   xdot(1) = u_fb*taylor_cos(theta, x_d(3));
% 	xdot(2) = u_fb*taylor_sin(theta, x_d(3));
% 	xdot(3) = u_fb*taylor_tan(delta_fb, u_d(1))/L;
%     xdot(1) = ( - 1.2725214076702032 * (-1.4999999999999998 + x(1)) - 0.43422590840574715 * (-0.78539816339744839 + x(3)) - 1.8386650774464175 * (6.9388939039072284e-18 + x(2)) + ((0.86845181681149441 * ((-0.78539816339744839 + x(3))^2)) / 2) + 3 * ((1.2725214076702032 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^2)) / 6) + 2 * ((1.2725214076702034 * (-1.4999999999999998 + x(1)) * (-0.78539816339744839 + x(3))) / 2) + ((1.3026777252172415 * ((-0.78539816339744839 + x(3))^3)) / 6) + 3 * ((1.8386650774464175 * ((-0.78539816339744839 + x(3))^2) * (6.9388939039072284e-18 + x(2))) / 6) + 2 * ((1.8386650774464179 * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 2));
%     xdot(2) = ( - 1.2725214076702034 * (-1.4999999999999998 + x(1)) - 0.43422590840574721 * (-0.78539816339744839 + x(3)) - 1.8386650774464179 * (6.9388939039072284e-18 + x(2)) + 2 * ((-1.8386650774464175 * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 2) + 2 * ((-1.2725214076702032 * (-1.4999999999999998 + x(1)) * (-0.78539816339744839 + x(3))) / 2) + ((-0.8684518168114943 * ((-0.78539816339744839 + x(3))^2)) / 2) + 3 * ((1.2725214076702034 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^2)) / 6) + ((1.3026777252172417 * ((-0.78539816339744839 + x(3))^3)) / 6) + 3 * ((1.8386650774464179 * ((-0.78539816339744839 + x(3))^2) * (6.9388939039072284e-18 + x(2))) / 6));
%     xdot(3) = (((-9.3589626903446383 * ((-1.4999999999999998 + x(1))^2)) / 2) + 2 * ((-3.522757068084176 * (-1.4999999999999998 + x(1)) * (6.9388939039072284e-18 + x(2))) / 2) + ((4.6427137573076687 * ((-0.78539816339744839 + x(3))^2)) / 2) + 2 * ((5.2060639650985125 * (-1.4999999999999998 + x(1)) * (-0.78539816339744839 + x(3))) / 2) + ((9.3589626903446277 * ((6.9388939039072284e-18 + x(2))^2)) / 2) + 2 * ((10.934564246829954 * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 2));
xdot(1) = ( - 1.2725214076702032 * (-1.4999999999999998 + x(1)) - 0.43422590840574715 * (-0.78539816339744839 + x(3)) - 1.8386650774464175 * (6.9388939039072284e-18 + x(2)) + 4 * ((-1.8386650774464179 * ((-0.78539816339744839 + x(3))^3) * (6.9388939039072284e-18 + x(2))) / 24) + ((-1.7369036336229888 * ((-0.78539816339744839 + x(3))^4)) / 24) + 4 * ((-1.2725214076702034 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^3)) / 24) + ((0.86845181681149441 * ((-0.78539816339744839 + x(3))^2)) / 2) + 3 * ((1.2725214076702032 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^2)) / 6) + 2 * ((1.2725214076702034 * (-1.4999999999999998 + x(1)) * (-0.78539816339744839 + x(3))) / 2) + ((1.3026777252172415 * ((-0.78539816339744839 + x(3))^3)) / 6) + 3 * ((1.8386650774464175 * ((-0.78539816339744839 + x(3))^2) * (6.9388939039072284e-18 + x(2))) / 6) + 2 * ((1.8386650774464179 * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 2));
xdot(2) = ( - 1.2725214076702034 * (-1.4999999999999998 + x(1)) - 0.43422590840574721 * (-0.78539816339744839 + x(3)) - 1.8386650774464179 * (6.9388939039072284e-18 + x(2)) + 2 * ((-1.8386650774464175 * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 2) + 2 * ((-1.2725214076702032 * (-1.4999999999999998 + x(1)) * (-0.78539816339744839 + x(3))) / 2) + ((-0.8684518168114943 * ((-0.78539816339744839 + x(3))^2)) / 2) + 4 * ((1.2725214076702032 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^3)) / 24) + 3 * ((1.2725214076702034 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^2)) / 6) + ((1.3026777252172417 * ((-0.78539816339744839 + x(3))^3)) / 6) + ((1.7369036336229886 * ((-0.78539816339744839 + x(3))^4)) / 24) + 4 * ((1.8386650774464175 * ((-0.78539816339744839 + x(3))^3) * (6.9388939039072284e-18 + x(2))) / 24) + 3 * ((1.8386650774464179 * ((-0.78539816339744839 + x(3))^2) * (6.9388939039072284e-18 + x(2))) / 6));
xdot(3) = (((-253.11795774158807 * ((-1.4999999999999998 + x(1))^4)) / 24) + 6 * ((-204.69078848468808 * ((-1.4999999999999998 + x(1))^2) * ((-0.78539816339744839 + x(3))^2)) / 24) + 9 * ((-150.26579688001956 * (-1.4999999999999998 + x(1)) * (-0.78539816339744839 + x(3)) * ((6.9388939039072284e-18 + x(2))^2)) / 24) + 3 * ((-150.26579688001954 * (-1.4999999999999998 + x(1)) * (-0.78539816339744839 + x(3)) * ((6.9388939039072284e-18 + x(2))^2)) / 24) + 6 * ((-144.12909521105536 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^2) * (6.9388939039072284e-18 + x(2))) / 24) + 5 * ((-144.12909521105533 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^2) * (6.9388939039072284e-18 + x(2))) / 24) + ((-144.1290952110553 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^2) * (6.9388939039072284e-18 + x(2))) / 24) + 4 * ((-110.40793595936748 * (-1.4999999999999998 + x(1)) * ((6.9388939039072284e-18 + x(2))^3)) / 24) + ((-9.3589626903446383 * ((-1.4999999999999998 + x(1))^2)) / 2) + 2 * ((-3.522757068084176 * (-1.4999999999999998 + x(1)) * (6.9388939039072284e-18 + x(2))) / 2) + ((4.6427137573076687 * ((-0.78539816339744839 + x(3))^2)) / 2) + 2 * ((5.2060639650985125 * (-1.4999999999999998 + x(1)) * (-0.78539816339744839 + x(3))) / 2) + ((9.3589626903446277 * ((6.9388939039072284e-18 + x(2))^2)) / 2) + 2 * ((10.934564246829954 * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 2) + 6 * ((20.530105119262458 * ((-1.4999999999999998 + x(1))^2) * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 24) + 3 * ((20.530105119262466 * ((-1.4999999999999998 + x(1))^2) * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 24) + 2 * ((20.530105119262487 * ((-1.4999999999999998 + x(1))^2) * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 24) + ((20.530105119262494 * ((-1.4999999999999998 + x(1))^2) * (-0.78539816339744839 + x(3)) * (6.9388939039072284e-18 + x(2))) / 24) + 2 * ((39.952794597684104 * ((-1.4999999999999998 + x(1))^3) * (6.9388939039072284e-18 + x(2))) / 24) + 2 * ((39.952794597684111 * ((-1.4999999999999998 + x(1))^3) * (6.9388939039072284e-18 + x(2))) / 24) + 4 * ((57.51536955197858 * (-1.4999999999999998 + x(1)) * ((-0.78539816339744839 + x(3))^3)) / 24) + 4 * ((65.938703934695283 * ((-1.4999999999999998 + x(1))^2) * ((6.9388939039072284e-18 + x(2))^2)) / 24) + 2 * ((65.938703934695297 * ((-1.4999999999999998 + x(1))^2) * ((6.9388939039072284e-18 + x(2))^2)) / 24) + ((121.24054987219706 * ((6.9388939039072284e-18 + x(2))^4)) / 24) + 2 * ((198.16117981733629 * (-0.78539816339744839 + x(3)) * ((6.9388939039072284e-18 + x(2))^3)) / 24) + 2 * ((198.16117981733632 * (-0.78539816339744839 + x(3)) * ((6.9388939039072284e-18 + x(2))^3)) / 24) + ((254.38707618198993 * ((-1.4999999999999998 + x(1))^3) * (-0.78539816339744839 + x(3))) / 24) + 3 * ((254.38707618198995 * ((-1.4999999999999998 + x(1))^3) * (-0.78539816339744839 + x(3))) / 24) + ((265.37149117095504 * ((-0.78539816339744839 + x(3))^4)) / 24) + 6 * ((297.54506363084107 * ((-0.78539816339744839 + x(3))^2) * ((6.9388939039072284e-18 + x(2))^2)) / 24) + 4 * ((375.67017472556995 * ((-0.78539816339744839 + x(3))^3) * (6.9388939039072284e-18 + x(2))) / 24));
end


function xdot = full_dynamics(t,x,x_d)
    xdot = x;
    L=1;
    u_d = [0;0];
    K = [-2.60026509,  1.79961703,  3.78016871; ...
          1.79961703,  2.60026509,  0.61408817];

    
    U = u_d - K*(x-x_d); 
	delta_fb = U(1);
	u_fb = U(2);
	theta = x(3);
            
%   xdot(1) = u_fb*cos(theta);
% 	xdot(2) = u_fb*sin(theta);
% 	xdot(3) = u_fb*tan(delta_fb)/L;
    xdot(1) = (( - 1.7996170331373038 * (-1.4999999999999998 + x(1)) - 0.614088168801185 * (-0.78539816339744839 + x(3)) - 2.6002650891865011 * (6.9388939039072284e-18 + x(2))) * cos(x(3)));
    xdot(2) = (( - 1.7996170331373038 * (-1.4999999999999998 + x(1)) - 0.614088168801185 * (-0.78539816339744839 + x(3)) - 2.6002650891865011 * (6.9388939039072284e-18 + x(2))) * sin(x(3)));
    xdot(3) = (( - 1.7996170331373038 * (-1.4999999999999998 + x(1)) - 0.614088168801185 * (-0.78539816339744839 + x(3)) - 2.6002650891865011 * (6.9388939039072284e-18 + x(2))) * tan((2.600265089186502 * (-1.4999999999999998 + x(1)) - 3.7801687063692455 * (-0.78539816339744839 + x(3)) - 1.7996170331373023 * (6.9388939039072284e-18 + x(2)))));
end

function tc = taylor_cos(x, x0)
	tc = ( cos(x0) - sin(x0)*(x-x0) - (cos(x0)*(x-x0)^2)/2.0 ...
		 + (sin(x0)*(x-x0)^3)/6.0 + (cos(x0)*(x-x0)^4)/24.0 ) ;
end

function ts = taylor_sin(x, x0)
    ts = ( sin(x0) + cos(x0)*(x-x0) - (sin(x0)*(x-x0)^2)/2.0 ...
         - (cos(x0)*(x-x0)^3)/6.0  ) ;
end
function tt = taylor_tan(x, x0)
	tt = ( tan(x0) + (tan(x0)^2+1.0)*(x-x0) + ...
	     ((2.0*tan(x0)*(tan(x0)^2 + 1.0))*(x-x0)^2)/2.0  + ...
	     ((2.0*(tan(x0)^2 + 1)^2 + (4.0*tan(x0)^2)*(tan(x0)^2 + 1.0))...
             *(x-x0)^3)/6.0 );
end